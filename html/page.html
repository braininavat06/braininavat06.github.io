<!DOCTYPE html>
<html lang="kor">
<head>
    <div id="head"></div>
    <title>Medimory | 메디모리</title>
    <link id="page-css" rel="stylesheet" href="" crossorigin="anonymous">
    <style>
        body.hidden {
            display: none;
        }
    </style>
</head>
<body class="hidden">
    <nav id="nav"></nav>
    <div class="section_package">
        <aside id="aside"></aside>
        <section id="section">
            <div class="section_box">
                <div class="1 sectionBody">
                    <h1 id="title"></h1>
                    <hr>
                    <div id="time"></div>
                </div>
                <div class="2 sectionBody" id="content">
                </div>
            </div>
        </section>
    </div>
    <footer id="footer"></footer>

    <script type="module">
        const isProduction = !(
            window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1' ||
            window.location.hostname === '::1'
        );

        function routeCheck(type, name, route) {
            const baseURL = isProduction ? `https://braininavat06.github.io${route}` : `..${route}`;

            if(type == "css") {
                document.getElementById(`${name}`).href = baseURL;
            } else if(type == "js") {
                return baseURL;
            } else if(type == "src") {
                document.getElementById(`${name}`).src = baseURL;
            }
        }

        let htmlModule;

        async function loadModules() { 
            var jsRoute = routeCheck("js", 0, "/js/htmlModule.js");

            try {
                const module = await import(jsRoute);
                htmlModule = module.htmlModule;
            } catch (error) {
                console.error("모듈 로드 실패 :", error);
            }
        }

        async function getQuery() {
            const params = new URLSearchParams(window.location.search).get("Id");
            return params;
        }

        async function readPage(){
            const params = await getQuery();
            fetch("https://www.medimory.com/api/v1/read", {
                method: "POST",
                body: params
            })
                .then((response) => {
                    return response.json();
                })
                .then((data) => {
                    const table = data.Items[0];
                    if(table != null) {
                        var title = table.Title;
                        var time = table.Time;
                        var content = table.Content;

                        document.getElementById("title").innerHTML = title;
                        document.getElementById("time").innerHTML = `작성 시간 : ${time}`;
                        document.getElementById("content").innerHTML = content;
                    } else {
                        var content = "글을 불러올 수 없습니다.";
                    }
                })
                .catch((e) => console.log(e))
        }
        
        

        async function loadPage(){
            await loadModules();

            routeCheck("css", "page-css", "/css/main.css?v=" + htmlModule.version);
            document.getElementById("head").innerHTML = htmlModule.head;
            document.getElementById("nav").innerHTML = htmlModule.nav;
            routeCheck("css", "nav-css", "/css/nav.css?v=" + htmlModule.version);
            routeCheck("src", "logo", "/img/medimory-logo.png");
            document.getElementById("aside").innerHTML = htmlModule.aside;
            routeCheck("css", "aside-css", "/css/aside.css?v=" + htmlModule.version);
            document.getElementById("footer").innerHTML = htmlModule.footer;

            

            await new Promise(resolve => {
                const cssLoaded = () => {
                    const link = document.getElementById("page-css");
                    if (link.sheet && link.sheet.cssRules.length > 0) {
                        resolve();
                    } else {
                        setTimeout(cssLoaded, 100);
                    }
                };
                cssLoaded();
            });

            document.body.classList.remove("hidden")
            await readPage();
        }

        loadPage();
    </script>
</body>
</html>
